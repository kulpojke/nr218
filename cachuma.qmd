---
title: ""
format:
  html:
    theme: quartz
---

# Cachuma Solution

__Data provided__

|  Filename                        | Year | Description       |
|----------------------------------|------|-------------------|
| DEM/dem_[1-4].tif                | 2018 | tiled DEMs (USGS 3DEP) |
| s2_cachuma_median_2018-07-01.tif | 2018 | Sentinel -2 image |
| s2_cachuma_median_2024-02-01.tif | 2024 | Sentinel -2 image |
| cachuma_aoi.geojson              |  NA  | Box used to clip above datasets |

__Task__

Estimate the change in the volume of water that was in the reservoir between summer, 2018 and February, 2024. This can be done using tools that we have already used in this class.

## Mosaic DEM 

The DEM is in tiles so you need to mosaic it.  I used `Raster` > `Conversion` > `Polygonize`.


## Find the approximate summer 2018 Water surface 

This can be done using the 208 S2 image, or the DEM.   Here we will use the DEM for this step.

To do this, first create a hillshade to visualize the DEM (here shown as red relief).The lake surface (as determined by the USGS) is easily visible as a perfectly flat area. Use the information tool ![](img/info_tool.png){style="height: 1.2em"} to find the elevation of the lake surface (214.16 ft, shockingly close to sea level!). Then use the raster calculator and polygonize tool to segment out the lake surface (see @fig-surf2018). Now you can calculate the 2018 lake surface area and  you know the elevation ($z_{2018} = 65.2759659112~\text{m}$).  (Some people may be happy to use this DEM as is and calculate the change in volume in acre-feet, but I would much rather have it in $m^3$, so I converted the DEM values from ft to m (`dem@1 / 3.28084` ).)

>Note: For the raster calculator if yo us `dem@1 = 214.16` you will probably get an empty raster.  This is due to [floating-point representation](https://en.wikipedia.org/wiki/Floating-point_error_mitigation) error.  Instead use something like `dem@1 > 214.15 AND dem@1 < 214.17` 


![Lake surface in summer 2018 as estimated using the DEM](img/cachuma_2018.gif){#fig-surf2018}

Next find the surface area and elevation of the lake surface in February, 2024.  The process is similar to what that for 2018, but this time you will need to use the S2 image. Use the Modified Normalized Difference Water Index (MNDWI) to segment the lake surface. Calculate it with the raster calculator.  Results should be similar to @fig-MNDWI_2024.

$$ 
\mathrm{MNDWI} = \frac{green - SWIR}{green + SWIR}
$$

>Note: There are two SWIR bands in S2 imagery.  After trying both I determined SWIR1 was better in this case. This makes sense, because SWIR2 is more sensitive to soil moisture.  Here we only want the water surface.

![MNDWI calculated using SWIR1 from Sentinel-2 median composite imagery for February 2024. ](img/cachuma_MNDWI_2024.png){#fig-MNDWI_2024}

Then create a mask layer (MNDWI > 0) and polygonize (there will be other small polygons of small detached pools in the river above the reservoir, and below the dam.  Extract the polygon of interest.) Now you have the surfaces (or inundation areas) for 2018 and 2024 as shown in @fig-surfs.

![Approxinate extent of water in Lake Cachuma in summer, 2018 and February, 2024. ](img/cachuma_water_surfs.png){#fig-surfs}

If you use the "Add geometry attributes" tool on the two surface areas (you may need to use "Fix geometries" first) then you now have $z_{2018}$, $A_{2018}$, and $A_{2024}$.  Now you need $z_{2024}$.  To get this, create points along the 2024 polygon ("Points along geometry", I used 10m as interval).  Now sample the raster at those points ("Sample raster values").  If you look closely at the map, and as can be seen in @fig-points, you will notice that many of the points actually fall a little inside the 2018 boundary, i.e. on the water surface from 2018.  This is due to registration error (misalignment) and differences in resolution. 

![Some points in the 2024 water boundary fall inside of the 2018 boundary, which is nonsense.](img/points_in_water.png){#fig-points}

One way of reducing the error from this phenomenon is to extract some points from places where the 2024 water boundary runs across relatively flay areas.  In the locations horizontal displacements will only result in small vertical displacements (@fig-flats)

![Extracted points lying in fairly flat areas.](img/cachuma_flatish.png){#fig-flats}

Now use Excel, QGIS plotting tools (which kind of stink), or some other software of your choice to create a histogram of the extracted points elevations (@fig-hist). 

```{python}
#| fig-cap: "Histogram of extracted points with mean and median."
#| label: fig-hist
#| echo: false
#| warning: false
#| message: false
import geopandas as gpd
import matplotlib.pyplot as plt

fig = plt.gcf()
fig.patch.set_alpha(0) 

df = gpd.read_file('untracked_qgis/cachuma/flattish_points.geojson')

mu = round(df.SAMPLE_1.mean(), 2)
m = round(df.SAMPLE_1.median(), 2)

ax = df.SAMPLE_1.hist(bins=20, edgecolor='k', color='hotpink',)
ax.axvline(x=mu, color='lime', linestyle='--', label='Mean');
ax.axvline(x=m, color='darkred', label='Median');
legend = ax.legend();
legend.get_frame().set_alpha(0);
legend.get_frame().set_facecolor('none');
legend.get_frame().set_edgecolor('none');
for text in legend.get_texts():
    text.set_color('whitesmoke');
ax.text(0.77, 0.8, f'Mean = {mu}', transform=ax.transAxes, fontsize=10, color='whitesmoke');
ax.text(0.77, 0.75, f'Median = {m}', transform=ax.transAxes, fontsize=10, color='whitesmoke');
ax.set_facecolor('none');
```

Since the mean and median values are both $\approx$ 69.2, it would appear to be a good value to choose for $z_{2024}$. 

Next we will calculate the volume of slices of the reservoir between $z_{2018}$ and $z_{2024}$  For a given slice,

$$
V_{n} \approx \Delta z \times \frac{A_{n}+A_{n+1}}{2} 
$$

where the volume of the slice $V_{n}$ is approximated by the depth of the slice $\Delta z$ times the mean area of the top ($A_{n}+A_{n+1}$) and bottom ($A_{n}+A_{n}$) of the slice
